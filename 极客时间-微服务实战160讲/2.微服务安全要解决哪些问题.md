# 微服务安全架构要解决哪些问题

**OAuth2协议提出的背景：旨在解决开发系统间的授权问题**

## 三个角色

一般开放系统间的资源访问问题，会涉及到三个方面：

- 资源拥有者
- 客户应用
- 受保护的资源

<img src="https://oscimg.oschina.net/oscnet/up-e3b668fa9ca6d07f65c37362fa01bf329e4.png" style="zoom: 25%;" >

安全问题就出现在客户应用访问受保护资源是，可能会做一些其他的操作，比如，客户应用获取权限后，访问了一些隐私数据或者删除了一些文件，或者其他的破坏行为。

如何解决授权安全问题呢？

## 用户名密码复制

这种方式下，当客户应用要访问受保护资源的时候，先从资源拥有者拿到资源的用户名和密码，然后客户应用再去请求受保护资源。

相当于我们的密码都给到了客户应用，那么，一旦密码泄露，客户应用利用我们的密码做一些其他的事情，是非常危险的。**在开放系统间，这种方式是不适用的。**

<img src="https://oscimg.oschina.net/oscnet/up-13b0eac1026d5411a46eace37817c9f4e94.png" alt="image-20220428160432118" style="zoom: 25%;" />



## 万能钥匙

这种方式是在客户应用和受保护资源之间，通过协商或者制定协议，双方通过一个key做为权限认证和授权验证。比较适用于合作方之间的一种协作方式，通常我们调用三方API的时候，大多都是用过这种方式来约定的。

这种方式同样存在问题，不适用于客户应用是三方应用的场景，而且，developer key泄露之后，同样也面临安全问题。

<img src="https://oscimg.oschina.net/oscnet/up-0ce883371e4a6c338c345e90b7ad4f88ce3.png" alt="image-20220428160523603" style="zoom: 25%;" />



## 特殊令牌

使用特殊的密码或者令牌，这样，客户应用只能够访问受保护的资源，却没有权限去做其他的事情或者访问其他的资源。

思考一个问题🤔：

我们是如何管理这个令牌的呢？如何创建一个令牌，如何吊销一个令牌呢？

令牌的管理，可以使用OAuth2。

<img src="https://oscimg.oschina.net/oscnet/up-24a3308f572a520d45a0df8082b7afcc018.png" alt="image-20220428162207636" style="zoom: 25%;" />





## 传统单块应用安全

单体应用架构下，用户的权限校验一般比较简单，通过一个拦截器或者过滤器进行校验，如果校验通过，则进入到业务逻辑服务中。如果没有校验通过，请求就此拦截。

另外校验通过的情况下，应用服务会返回一个状态，客户端通过Cookie或者Session来记录和保存这个状态，下次的请求的时候，会携带这些状态进行校验。

<img src="https://oscimg.oschina.net/oscnet/up-8c15c1b37badaf83364551d8f0fd02ee797.png" style="zoom:25%;" />





## 现代微服务安全



随着业务规模的增加，单体应用服务器不再满足业务需求，随之而来的是微服务架构。

微服务架构要求我们正确合理的拆分我们的服务，这样，服务之间的授权问题随之诞生。而且，随着业务的增长，接入端的形态变得更加多样，Web服务，移动端APP或者其他的服务都可能存在。此时授权和校验的工作将单独抽离出一个模块，AuthServer来完成整体的授权和校验。

而且，使用Token代理单体架构下的Cookie和Session。



<img src="https://oscimg.oschina.net/oscnet/up-b01dab2f6da52f01c74f7b5aa338ce7bd33.png" alt="image-20220428164717112" style="zoom: 25%;" />





## OAuth2解决问题域和场景



- 开放系统间的授权问题
  - 社交联合登录
  - 开放API平台
- 现代微服务安全
  - 单页浏览器APP
  - 无线原声APP
  - 服务端WebAPP
  - 微服务API之间的调用
- 企业内部应用认证授权