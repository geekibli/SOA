# 配置的定义和场景

## 1. 配置的定义

### 1.1 配置定义

- 可独立于程序的可配**变量**
- 同一份程序在不同的配置下有不同的行为
- 连接字符串，应用配置，业务配置

### 1.2 配置形态

- 程序内部hardcode （这种不推荐）
- 配置文件 （bootstrap / properrties）
- 环境变量
- 启动参数
- 基于数据库

### 1.3 配置治理

- 权限控制和审计
- 不同环境、集群配置管理
- 框架类组件配置管理
- 灰度发布



## 2. 配置的分类和场景

配置可以分成**静态**配置和**动态**配置两大类

<img src="https://oscimg.oschina.net/oscnet/up-5a312b8826a04b139d18d717598da1e1f5b.png" width=700 height=320 />





### 2.1 蓝绿发布

蓝绿部署中，一共有两套系统：一套是正在提供服务系统（也就是上面说的旧版），标记为“绿色”；另一套是准备发布的系统，标记为“蓝色”。两套系统都是功能完善的，并且正在运行的系统，只是系统版本和对外服务情况不同。正在对外提供服务的老系统是绿色系统，新部署的系统是蓝色系统。

<img src="https://oscimg.oschina.net/oscnet/up-e983e252ee2c6bb0fcae0e2ef33cad4c14d.png"  width=700 height=320  >



**蓝色系统不对外提供服务，用来做啥？**

> 用来做发布前测试，测试过程中发现任何问题，可以直接在蓝色系统上修改，不干扰用户正在使用的系统。

蓝色系统经过反复的测试、修改、验证，确定达到上线标准之后，直接将用户切换到蓝色系统，切换后的一段时间内，**依旧是蓝绿两套系统并存**，但是用户访问的已经是蓝色系统。这段时间内观察蓝色系统（新系统）工作状态，如果出现问题，直接切换回绿色系统。

当确信对外提供服务的蓝色系统工作正常，不对外提供服务的绿色系统已经不再需要的时候，蓝色系统正式成为对外提供服务系统，成为新的绿色系统。 原先的绿色系统可以销毁，将资源释放出来，用于部署下一个蓝色系统。

#### 2.1.1 蓝绿发布特点

1. 蓝绿部署的目的是**减少发布时的中断时间**、**能够快速撤回发布**。
2. 两套系统没有耦合的时候才能百分百保证不干扰



#### 2.1.2 蓝绿发布注意事项

蓝绿部署只是上线策略中的一种，它不是可以应对所有情况的万能方案。 蓝绿部署能够简单快捷实施的前提假设是目标系统是非常内聚的，如果目标系统相当复杂，那么如何切换、两套系统的数据是否需要以及如何同步等，都需要仔细考虑。

当你切换到蓝色环境时，需要妥当处理未完成的业务和新的业务。如果你的数据库后端无法处理，会是一个比较麻烦的问题：

- 可能会出现需要同时处理“微服务架构应用”和“传统架构应用”的情况，如果在蓝绿部署中协调不好这两者，还是有可能会导致服务停止。
- 需要提前考虑数据库与应用部署同步迁移/回滚的问题。
- 蓝绿部署需要有基础设施支持。
- 在非隔离基础架构（VM 、 Docker等）上执行蓝绿部署，蓝色环境和绿色环境有被摧毁的风险。





### 2.2 功能降级

当客户端请求压力非常大或者程序正在遭受DDOS攻击的时候，为了保证用户正常的使用，可以采用一些降级策略保证页面的正常可用。

比如给页面返回一些友好提示：网路不给力，请稍后重试。

甚至可以做的更详细一些，一些普通用户可以直接给出一些提示，一些VIP高级用户可以保证起正常的访问页面。

或者一些不是很重要的信息，不如一些广告信息，促销信息等可以先关掉，来保证页面的可用。

<img src="https://oscimg.oschina.net/oscnet/up-d07140a54974c9613e2473b92d11d49c6ed.png"  width=800 height=380 >





### 2.3 DB / Schema迁移

> Blog 地址 https://launchdarkly.com/blog/feature-flagging-to-mitigate-risk-in-database-migration/

大致思想就是一个渐进式的迁移思路。可以读一下原文。

<img src="https://oscimg.oschina.net/oscnet/up-ac6686e8e514e6b5efa63091a51fa40b88b.png"  width=600 height=620 >





### 2.4 A/B测试

A/B测试也同样可以使用配置中心来进行控制。

<img src ="https://oscimg.oschina.net/oscnet/up-be7f7ee6cf4828f962a23963c25beb22eaf.png"  width=500 height=130 >

**beta**客户可以使用最新的版本

**regular**客户继续使用之前的版本

在新版本稳定之后，在把regular切换到最新的版本上

