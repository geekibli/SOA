# 配置中心业务需求

## 从一个真实生产案例开始，介绍微服务配置中心。

公司要开展双十一促销活动，其中的某个商品限制每个人购买数量，但是，这个数量怎么定是无法精确预估的，一般上线之前只能拍脑袋顶一个大致数量。然后在根据实际情况做出调整。

调整的目的是为了雨露均沾，减小每个人限购商品数量，让更多的人能够买到商品。

于是一个没有竟然的工程师接了需求，他的代码是这样写的👇	

<img src="https://oscimg.oschina.net/oscnet/up-373fa6bfd2e370a6cf2cf3f63c54aa19c92.png" width=600 height=240>

**思考这样写有没有什么问题？**

代码上线几个小时之后，由于商品确实销售比较火爆，需要调整每个人限购商品数量，由于上线的时候，配置的是10，需要调整成2。

但是数量都写在代码里了，相当于写死了。

然后这个工程师只能修改代码，然后提交代码，发版......

整个流程下来，可能到半个小时或者更久的时间

这时候一个比较有经验的大佬过来了，他说这种业务场景，必须要借助配置中心，才可以随时完成配置切换。

<img src="https://oscimg.oschina.net/oscnet/up-a775fbe6e45509f22bbbe7e25c09e0288fe.png" width=400 height=100>

只需要将这个配置写在集中式配置中心的配置文件中，可以在很短的时间内完成切换。**不需要服务中心发版。**



根据上面的真实场景下，我们引出一个问题。



## 为什么需要配置中心



### 传统的应用配置有什么问题

1. 主要采用本地文件静态配置 （本地静态配置导致在运行时无法动态修改）
2. 配置格式散乱，不标准 （有的用xml格式，有的用properties， 有的村DB）
3. 易发生生产事故 (发布的时候容易将非生产的配置带到生产上，引发事故)
4. 配置修改麻烦，周期长 （当部署的服务器很多时，修改配置费时费力）
5. 配置信息缺少安全审计和版本控制功能 （事后无法追溯，出现问题无法及时回滚）



### 配置中心是如何解决上面这个问题的呢？

1. 集中式配置，所有的配置都存放在配置中心
2. 配置中心提供了统一的配置管理，统一的配置格式和接口
3. 配置中心能够提供环境的隔离和配置的即时生效，不同的环境配置不同的内容，并且能在秒级完成配置的更改和切换
4. 配置只需要集中修改一次，便可以短时间内同步到各个使用端
5. 所有的配置文件都有历史记录，方便查找修改人和修改时间，同时提供历史版本，方便回退版本





## 云原生下的配置要求

比如Docker等容器技术，都采用镜像的方式，部署服务到不同的环境。但是，镜像只有一份，也就是说，不同的环境使用的是同一份镜像。

但是不同的环境，使用的配置文件却是不同的，因此，云原生下服务配置的要求就是服务镜像需要和配置文件分离。



## 现在配置的核心需求

### 交付件和配置分离

如上面云原生部分所说，镜像只有一份且是不可变的，将同一份镜像发不到不同的环境下，需要不同的配置文件，所有，镜像和配置文件需要分离。

### 抽象标准化

配置中心需要屏蔽掉配置文件格式的差异性，统一定义或者抽象配置格式，统一接口格式。

### 集中式

配置集中式修改，一处修改，所依赖的所有服务器都可短时间内获取到最新的配置。整个部门甚至整个业务线都可以使用同一套配置中心而不是每个组用自己的。

### 高可用

配置中心必须是高可用的，配置中心一旦宕机，则会造成整个业务线的不可使用

### 实时性

配置的修改需要秒级响应，在短时间内更新到应用服务器

### 治理

配置中心提供配置的修改记录和历史版本的管理，使用人员的权限控制和配置内容的更新审计等功能





## 一些大厂开源的配置中心

- 国内阿里开源的Diamond
- 携程开源的Apollo
- 百度开源的Disconf
- 国外Netflix开源的Archaius
- Facebook开源的Gatekeeper

