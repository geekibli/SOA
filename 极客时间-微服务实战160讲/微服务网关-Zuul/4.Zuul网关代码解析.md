# Zuulç½‘å…³ä»£ç è§£æ



**ä¸‹é¢ä¸»è¦æ˜¯è¿‡æ»¤å™¨åŠ è½½æ¨¡å—å’Œè¿‡æ»¤å™¨è¿è¡Œæ—¶æ¨¡å—çš„æ ¸å¿ƒä»£ç çš„ä»‹ç»ã€‚**



**Netflux Zuulæºç ï¼š** https://github.com/Netflix/zuul

**æ•™å­¦ç‰ˆæœ¬çš„æºç ï¼š**https://github.com/spring2go/s2g-zuul



## ç§»åŠ¨ç«¯ç½‘å…³é‡è¦ç±»



**InitializeServletListener** ç½‘å…³å¯åŠ¨æ—¶ï¼Œåšä¸€äº›åˆå§‹åŒ–å·¥ä½œ

**SyncZuulServlet**ï¼šåŒæ­¥æ¨¡å¼çš„Zuulç½‘å…³å¯åŠ¨ç¨‹åºï¼Œä¹Ÿæ˜¯ZuulåŸç”Ÿé»˜è®¤çš„å¯åŠ¨æ–¹å¼

**AsyncZuulServlet**ï¼šå¼‚æ­¥æ¨¡å¼çš„Zuulç½‘å…³å¯åŠ¨ç¨‹åºï¼ˆè‡ªå®šåˆ¶çš„ï¼‰



é¦–å…ˆè¯´ä¸€ä¸‹è¿‡æ»¤å™¨çš„å­˜å‚¨å’ŒåŠ è½½è¿‡ç¨‹çš„æºç å§ï¼



## InitializeServletListener

åœ¨ç½‘å…³å¯åŠ¨çš„æ—¶å€™ï¼Œåšä¸€äº›åˆå§‹åŒ–å·¥ä½œ

- åŠ è½½é…ç½®
- é…ç½®æ—¥å¿—
- æ³¨å†Œeureka

```java
	public InitializeServletListener() {
//		System.setProperty(Constants.DEPLOY_ENVIRONMENT, "test");
//		System.setProperty(Constants.DEPLOYMENT_APPLICATION_ID, "mobile_zuul");
//		System.setProperty(Constants.DEPLOY_CONFIG_URL, "http://localhost:8080/configfiles/mobile_zuul/default/application");			
		String applicationID = ConfigurationManager.getConfigInstance().getString(Constants.DEPLOYMENT_APPLICATION_ID);
		if (StringUtils.isEmpty(applicationID)) {
			LOGGER.warn("Using default config!");
			ConfigurationManager.getConfigInstance().setProperty(Constants.DEPLOYMENT_APPLICATION_ID, "mobile_zuul");
		}
		
		System.setProperty(DynamicPropertyFactory.ENABLE_JMX, "true");
		
        loadConfiguration();
        configLog();
        registerEureka();
	}
```

InitializeServletListener å®ç°äº† ServletContextListenerçš„æ¥å£

```
public class InitializeServletListener implements ServletContextListener {}
```

åœ¨Zuulå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¼šè°ƒç”¨contextInitializedæ–¹æ³•ï¼š

```java
@Override
	public void contextInitialized(ServletContextEvent arg0) {
        try {
        		initInfoBoard();
            initMonitor();
            initZuul();
            updateInstanceStatusToEureka();
        } catch (Exception e) {
        	LOGGER.error("Error while initializing zuul gateway.", e);
        	throw new RuntimeException(e);
        }
	
```

ä¸»è¦åšäº†ä¸€äº›å‡ ä¸ªæ“ä½œï¼š

- initInfoBoardï¼š ç”¨æ¥æŸ¥çœ‹ç½‘å…³å†…éƒ¨çš„ä¸€äº›çŠ¶æ€
- initMonitorï¼šzuulå†…éƒ¨çš„ä¸€äº›ç›‘æ§å’ŒåŸ‹ç‚¹
- initZuulï¼šåˆå§‹åŒ–zuul
- updateInstanceStatusToEureka: æ³¨å†ŒEurekaï¼Œä¿®æ”¹EurekaçŠ¶æ€



é‡ç‚¹æ–¹æ³•å°±æ˜¯ç¬¬ä¸‰ä¸ªï¼Œ**initZuul**ï¼›



ä¸‹é¢æ˜¯initZuulæ–¹æ³•çš„æºç ï¼š ğŸ‘‡



```java
private void initZuul() throws Exception {
    LOGGER.info("Starting Groovy Filter file manager");
    final AbstractConfiguration config = ConfigurationManager.getConfigInstance();
    final String preFiltersPath = config.getString(Constants.ZUUL_FILTER_PRE_PATH);
    final String postFiltersPath = config.getString(Constants.ZUUL_FILTER_POST_PATH);
    final String routeFiltersPath = config.getString(Constants.ZUUL_FILTER_ROUTE_PATH);
    final String errorFiltersPath = config.getString(Constants.ZUUL_FILTER_ERROR_PATH);
    final String customPath = config.getString(Constants.Zuul_FILTER_CUSTOM_PATH);

    //load local filter files
    FilterLoader.getInstance().setCompiler(new GroovyCompiler());
    FilterFileManager.setFilenameFilter(new GroovyFileFilter());
    if (customPath == null) {
    FilterFileManager.init(5, preFiltersPath, postFiltersPath, routeFiltersPath, errorFiltersPath);
    } else {
    FilterFileManager.init(5, preFiltersPath, postFiltersPath, routeFiltersPath, errorFiltersPath, customPath);
    }
    //load filters in DB
    startZuulFilterPoller();
    LOGGER.info("Groovy Filter file manager started");
}
```



é¦–å…ˆå¯ä»¥çœ‹åˆ°5ä¸ªè·¯å¾„ç›¸å…³çš„å˜é‡ï¼Œåˆ†åˆ«æ˜¯Zuulçš„è¿‡æ»¤å™¨çš„å­˜æ”¾è·¯å¾„ã€‚è¿™äº›è·¯å¾„éƒ½æ˜¯å¯ä»¥é…ç½®çš„ã€‚é™¤äº†Zuulè‡ªå·±å®šä¹‰çš„4ç§è¿‡æ»¤å™¨ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°customPathï¼Œè¿™æ˜¯è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨çš„å­˜æ”¾è·¯å¾„ã€‚



è·¯å¾„å¯ä»¥é…ç½®åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ–è€…å†™åœ¨é›†ä¸­å¼çš„é…ç½®ä¸­å¿ƒã€‚

```properties
zuul.filter.pre.path=/opt/app/zuul/scripts/pre
zuul.filter.route.path=/opt/app/zuul/scripts/route
zuul.filter.post.path=/opt/app/zuul/scripts/post
zuul.filter.error.path=/opt/app/zuul/scripts/error
```



æ¥ä¸‹æ¥å°±æ˜¯å»è®¾ç½®FilterLoader å’Œ FilterFileManageräº†ã€‚ ç›¸å…³çš„ä»£ç å¦‚ä¸‹ï¼š



```java
//load local filter files
FilterLoader.getInstance().setCompiler(new GroovyCompiler());
FilterFileManager.setFilenameFilter(new GroovyFileFilter());
if (customPath == null) {
  // è¿™é‡Œéœ€è¦å°†å„ç§è¿‡æ»¤å™¨çš„è·¯å¾„å‘Šè¯‰FilterFileManagerã€‚
	FilterFileManager.init(5, preFiltersPath, postFiltersPath, routeFiltersPath, errorFiltersPath);
} else {
	FilterFileManager.init(5, preFiltersPath, postFiltersPath, routeFiltersPath, errorFiltersPath, customPath);
}
```



è¿™é‡Œéœ€è¦å°†å„ç§è¿‡æ»¤å™¨çš„è·¯å¾„å‘Šè¯‰FilterFileManagerã€‚

```
public static void init(int pollingIntervalSeconds, String... directories)
			throws Exception, IllegalAccessException, InstantiationException {
		getInstance();

		instance.aDirectories = directories;
		instance.pollingIntervalSeconds = pollingIntervalSeconds;
		instance.manageFiles();
		instance.startPoller();
}
```



1. é¦–å…ˆè·å–ä¸€ä¸ªFilterFileManagerï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯DCLçš„æ–¹å¼è·å–ä¸€ä¸ªå®ä¾‹
2. è·å–å®ä¾‹ä¹‹åï¼Œè®¾ç½®å®ä¾‹çš„å„ç§è¿‡æ»¤å™¨çš„è·¯å¾„
3. å»ä¸Šä¸€æ­¥é…ç½®çš„è·¯å¾„ä¸‹æŸ¥æ‰¾è¿‡æ»¤å™¨ï¼Œç„¶åäº¤ç»™FilterLoaderå¤„ç†
4. æœ€åå¯åŠ¨ä¸€ä¸ªPoolerå®šæ—¶å»æŸ¥çœ‹è·¯å¾„ä¸‹çš„è¿‡æ»¤å™¨æ˜¯å¦æœ‰å˜æ›´



```java
protected void startPoller() {
		if (poller == null) {
			poller = new Thread("GroovyFilterFileManagerPoller") {
				public void run() {
					while (bRunning) {
						try {
							sleep(pollingIntervalSeconds * 1000);
							manageFiles();
						} catch (Exception e) {
							e.printStackTrace();
						}
					}
				}
			};
			poller.start();
		}
		
	}
```



æ¯éš”1sè°ƒç”¨ä¸€æ¬¡manageFilesæ–¹æ³•ï¼Œå®šæ—¶å»æŸ¥çœ‹è¿‡æ»¤å™¨çš„å˜æ›´æƒ…å†µã€‚



```java
/**
	 * puts files into the FilterLoader. The FilterLoader will only addd new or
	 * changed filters
	 *
	 * @param aFiles
	 *            a List<File>
	 * @throws IOException
	 * @throws InstantiationException
	 * @throws IllegalAccessException
	 */
	private void processGroovyFiles(List<File> aFiles)
			throws Exception, InstantiationException, IllegalAccessException {

		for (File file : aFiles) {
			FilterLoader.getInstance().putFilter(file);
		}
	}

	protected void manageFiles() throws Exception, IllegalAccessException, InstantiationException {
		List<File> aFiles = getFiles();
		processGroovyFiles(aFiles);
	}
```



manageFilesæ–¹æ³•è·å–çš„è¿‡æ»¤å™¨å…¨éƒ¨äº¤ç»™ FilterLoader å¤„ç†ã€‚



```java
public boolean putFilter(File file) throws Exception {
        String sName = file.getAbsolutePath() + file.getName();
        if (filterClassLastModified.get(sName) != null && (file.lastModified() != filterClassLastModified.get(sName))) {
            LOGGER.debug("reloading filter " + sName);
            filterRegistry.remove(sName);
        }
        ZuulFilter filter = filterRegistry.get(sName);
        if (filter == null) {
            Class clazz = COMPILER.compile(file);
            if (!Modifier.isAbstract(clazz.getModifiers())) {
                filter = (ZuulFilter) FILTER_FACTORY.newInstance(clazz);
                filterRegistry.put(file.getAbsolutePath() + file.getName(), filter);
                filterClassLastModified.put(sName, file.lastModified());
                List<ZuulFilter> list = hashFiltersByType.get(filter.filterType());
                if (list != null) {
                    hashFiltersByType.remove(filter.filterType()); //rebuild this list
                }
                return true;
            }
        }

        return false;
    }  
```



å¤§è‡´å·¥ä½œå°±æ˜¯é€šè¿‡æ‹¿åˆ°çš„è¿‡æ»¤å™¨è¿›è¡Œç¼–è¯‘ï¼Œç¼–è¯‘ä¹‹åå°±å¯ä»¥æ‹¿åˆ°è¿‡æ»¤å™¨å¯¹åº”çš„å®ä¾‹ï¼Œç„¶åå­˜æ”¾èµ·æ¥ã€‚

å½“ç„¶è¿™é‡Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„åˆ¤æ–­ï¼Œæ¯”å¦‚è¿‡æ»¤å™¨çš„å˜æ›´ï¼Œæ˜¯å¦å·²ç»åŠ è½½è¿‡ç­‰ã€‚



åœ¨initZuulæ–¹æ³•çš„æœ€å ï¼Œæ˜¯ä¸‹é¢çš„ä»£ç ï¼š

```java
//load filters in DB
startZuulFilterPoller();
```



è¿™æ˜¯åšä»€ä¹ˆçš„å‘¢ï¼Ÿ



```java
 private void startZuulFilterPoller() {
     ZuulFilterPoller.start();
     LOGGER.info("ZuulFilterPoller Started.");
}
```



ZuulFilterPoller å…¶å®æ˜¯ä¸€ä¸ªç±»ï¼Œå†…éƒ¨æœ‰ä¸€ä¸ªçº¿ç¨‹æˆå‘˜ã€‚



```java
public static void start(){
		if(instance == null){
			synchronized(ZuulFilterPoller.class){
				if(instance == null){
					instance = new ZuulFilterPoller() ;
				}
			}
		}
	}
```



è°ƒç”¨startæ–¹æ³•ï¼Œå…¶å®æ˜¯é€šè¿‡DCLåˆ›å»ºä¸€ä¸ªZuulFilterPollerå®ä¾‹ï¼Œåœ¨ZuulFilterPollerçš„æ„é€ æ–¹æ³•ä¸­ï¼Œå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œ



```java
private ZuulFilterPoller(){
		this.checherThread.start();
	}
```

å¯åŠ¨ä¹‹åï¼Œè‡ªç„¶æ˜¯æ‰§è¡Œrunæ–¹æ³•ã€‚



**è¿™ä¸ªçº¿ç¨‹æˆå‘˜å¦‚ä¸‹ï¼š**



```java
private Thread checherThread = new Thread("ZuulFilterPoller") {

		public void run() {
			while (running) {
				try {
					if (!pollerEnabled.get())
						continue;
						// é‡‘ä¸é›€çŠ¶æ€
					if (canary.get()) {
						Transaction tran = Cat.getProducer().newTransaction("FilterPoller", "canary-"+ZuulFilterDaoFactory.getCurrentType());
						
						try{
							Map<String, FilterInfo> filterSet = Maps.newHashMap();
	
							List<FilterInfo> activeScripts = ZuulFilterDaoFactory.getZuulFilterDao().getAllActiveFilters();
	
							if (!activeScripts.isEmpty()) {
								for (FilterInfo filterInfo : activeScripts) {
									filterSet.put(filterInfo.getFilterId(), filterInfo);
								}
							}
	
							List<FilterInfo> canaryScripts = ZuulFilterDaoFactory.getZuulFilterDao().getAllCanaryFilters();
							if (!canaryScripts.isEmpty()) {
								for (FilterInfo filterInfo : canaryScripts) {
									filterSet.put(filterInfo.getFilterId(), filterInfo);
								}
							}
	
							for (FilterInfo filterInfo : filterSet.values()) {
								doFilterCheck(filterInfo);
							}
							tran.setStatus(Transaction.SUCCESS);
						}catch(Throwable t){
							tran.setStatus(t);
							Cat.logError(t);
						}finally{
							tran.complete();
						}
						// activeçŠ¶æ€
					} else if (active.get()) {
						Transaction tran = Cat.getProducer().newTransaction("FilterPoller", "active-"+ZuulFilterDaoFactory.getCurrentType());
						
						try{
							List<FilterInfo> newFilters = ZuulFilterDaoFactory.getZuulFilterDao().getAllActiveFilters();
							
							tran.setStatus(Transaction.SUCCESS);
							if (newFilters.isEmpty())
								continue;
							for (FilterInfo newFilter : newFilters) {
								doFilterCheck(newFilter);
							}
						}catch(Throwable t){
							tran.setStatus(t);
							Cat.logError(t);
						}finally{
							tran.complete();
						}
					}
				} catch (Throwable t) {
					LOGGER.error("ZuulFilterPoller run error!", t);
				} finally {
					try {
						sleep(pollerInterval.get());
					} catch (InterruptedException e) {
						LOGGER.error("ZuulFilterPoller sleep error!", e);
					}
				}
			}
		}
	};
```



å½“ç„¶è¿™ä¸ªçº¿ç¨‹ä¹Ÿä¸æ˜¯ä¸€ç›´è¿è¡Œçš„ï¼Œè€Œæ˜¯æ¯ä¸ªä¸€æ®µæ—¶é—´è¿è¡Œä¸€æ¬¡ã€‚

```java
try {
		sleep(pollerInterval.get());
	} catch (InterruptedException e) {
		LOGGER.error("ZuulFilterPoller sleep error!", e);
	}
```

é»˜è®¤æ—¶é—´æ˜¯30sï¼Œæ˜¯å¯ä»¥é…ç½®çš„ã€‚

```java
private DynamicLongProperty pollerInterval = DynamicPropertyFactory.getInstance()
			.getLongProperty(Constants.ZUUL_FILTER_POLLER_INTERVAL, 30000);
```



å› ä¸ºç½‘å…³å¯èƒ½ä¼šè¢«è®¾ç½®æˆä¸åŒçš„çŠ¶æ€ï¼Œæ¯”å¦‚é‡‘ä¸é›€çŠ¶æ€ã€‚è¿™ç§çŠ¶æ€ä¸‹åªä¼šå»æ•°æ®åº“ä¸­æŸ¥æ‰¾æ‰€æœ‰å¤„äº é‡‘ä¸é›€ çŠ¶æ€çš„ è¿‡æ»¤å™¨ã€‚

è·å–åˆ°æ‰€æœ‰å¯ç”¨çš„è¿‡æ»¤å™¨ä¹‹åï¼Œæœ€ä¸€äº›æ ¡éªŒï¼Œä¹‹åï¼Œå†™åˆ°å“åº”çš„è·¯å¾„ä¸‹ï¼Œç»™FilterFileManagerå®šæœŸæŸ¥çœ‹å˜æ›´çŠ¶æ€ã€‚



```java
private void doFilterCheck(FilterInfo newFilter) throws IOException {
		FilterInfo existFilter = runningFilters.get(newFilter.getFilterId());
		if (existFilter == null || !existFilter.equals(newFilter)) {
			LOGGER.info("adding filter to disk" + newFilter.toString());
			writeFilterToDisk(newFilter);
			runningFilters.put(newFilter.getFilterId(), newFilter);
		}
	}
```



æ­¤æ—¶ï¼Œç»“åˆZuulçš„æ¶æ„å›¾æ¥çœ‹æ˜¯ä¸æ˜¯æ¯”è¾ƒå¥½ç†è§£å‘¢



<img src="https://oscimg.oschina.net/oscnet/up-5e217ae8f5beba7028b6a561d17ea5d7dd7.png" width=700 height=450>





ä¸Šé¢å·²ç»å°†è¿‡æ»¤å™¨çš„ç®¡ç†å’ŒåŠ è½½ç¯èŠ‚çš„å…³é”®ä»£ç ï¼Œæœ‰äº†å¤§è‡´çš„äº†è§£ã€‚ä¹Ÿå°±æ˜¯æ¶æ„å›¾ä¸­ï¼Œç»¿è‰²å’Œç²‰è‰²çš„éƒ¨åˆ†ã€‚

ä¸‹é¢ä¸»è¦çœ‹ä¸€ä¸‹è“è‰²éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯è¿è¡Œæ—¶éƒ¨åˆ†çš„æ ¸å¿ƒä»£ç å§

ä¸‹é¢ä»¥SyncZuulServletä¸ºä¾‹å±•å¼€ã€‚

SyncZuulServlet ç»§æ‰¿äº† HttpServletï¼Œ å¹¶é‡å†™äº†serviceæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨æ‰§è¡ŒServletä¸­æ˜¯ä¸€å®šä¼šè¢«è°ƒç”¨çš„ã€‚

```
public class SyncZuulServlet extends HttpServlet {}
```



serviceæ–¹æ³•æºç å¦‚ä¸‹ ğŸ‘‡



```java
@Override
    public void service(javax.servlet.ServletRequest req, javax.servlet.ServletResponse res) throws javax.servlet.ServletException, java.io.IOException {
        try {


            init((HttpServletRequest) req, (HttpServletResponse) res);

            // marks this request as having passed through the "Zuul engine", as opposed to servlets
            // explicitly bound in web.xml, for which requests will not have the same data attached
            RequestContext.getCurrentContext().setZuulEngineRan();

            try {
                preRoute();
            } catch (ZuulException e) {
                error(e);
                postRoute();
                return;
            }
            try {
                route();
            } catch (ZuulException e) {
                error(e);
                postRoute();
                return;
            }
            try {
                postRoute();
            } catch (ZuulException e) {
                error(e);
                return;
            }

        } catch (Throwable e) {
            error(new ZuulException(e, 500, "UNHANDLED_EXCEPTION_" + e.getClass().getName()));
        } finally {
        	RequestContext.getCurrentContext().unset();
        }
    }
```



ä»ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå¾ˆæ¸…æ™°ï¼Œæœ‰æ²¡æœ‰ï¼ŒZuulè¿‡æ»¤å™¨çš„æ‰§è¡Œé€»è¾‘ï¼Œå…ˆæ‰§è¡Œpreï¼Œç„¶åæ‰§è¡Œrouteï¼Œæœ€åæ‰§è¡Œpostã€‚å’Œæˆ‘ä»¬æ¶æ„å›¾ä¸­çš„æµç¨‹æ˜¯ä¸€è‡´çš„ã€‚



æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æ˜¯å¦‚ä½•æ‰§è¡Œpreçš„ã€‚

å…ˆè°ƒç”¨äº†zuulRunnerçš„preRoute()æ–¹æ³•ã€‚

```java
void preRoute() throws ZuulException {
    	zuulRunner.preRoute();
}
```



å…¶å®ï¼Œæ˜¯è°ƒç”¨FilterProcessorçš„preRouteæ–¹æ³•ã€‚

```java
public void preRoute() throws ZuulException {
		FilterProcessor.getInstance().preRoute();
}
```



è¿™é‡Œå…¶å®å°±æ˜¯æ‰§è¡Œæ‰€æœ‰ç±»å‹æ˜¯preçš„è¿‡æ»¤å™¨ã€‚

```java
public void preRoute() throws ZuulException {
		try {
			runFilters("pre");
		} catch (Throwable e) {
			if (e instanceof ZuulException) {
				throw (ZuulException) e;
			}
			throw new ZuulException(e, 500, "UNCAUGHT_EXCEPTION_IN_PRE_FILTER_" + e.getClass().getName());
		}
	}
```



é‚£ä¹ˆï¼Œè¿‡æ»¤å™¨æ˜¯åœ¨å“ªé‡Œæ‹¿çš„å‘¢ï¼Ÿ

å…¶å®å°±æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹è¯´çš„ï¼ŒFilterLoaderåŠ è½½çš„æ‰€æœ‰çš„è¿‡æ»¤å™¨ï¼Œç„¶åæŠŠç±»å‹æ˜¯preçš„è¿‡æ»¤å™¨ç­›é€‰å‡ºæ¥å°±å¯ä»¥äº†ã€‚

æ‹¿åˆ°æ‰€æœ‰çš„preè¿‡æ»¤å™¨ï¼Œå¹¶ä¸”æ˜¯æ‹å¥½é¡ºåºçš„ï¼Œ**åºå·è¶Šå°ï¼Œè¶Šå…ˆæ‰§è¡Œ**

```java
public Object runFilters(String sType) throws Throwable {
		if (RequestContext.getCurrentContext().debugRouting()) {
			Debug.addRoutingDebug("Invoking {" + sType + "} type filters");
		}
		boolean bResult = false;
		List<ZuulFilter> list = FilterLoader.getInstance().getFiltersByType(sType);
		if (list != null) {
			for (int i = 0; i < list.size(); i++) {
				ZuulFilter zuulFilter = list.get(i);
				Object result = processZuulFilter(zuulFilter);
				if (result != null && result instanceof Boolean) {
					bResult |= ((Boolean) result);
				}
			}
		}
		return bResult;
	}

```

å¾ªç¯è°ƒç”¨processZuulFilteræ¥æ‰§è¡Œè¿‡æ»¤å™¨é€»è¾‘ã€‚è¿™ä¸ªæ–¹æ³•æ ¸å¿ƒæ˜¯è°ƒç”¨äº† ğŸ‘‡

ZuulFilterResult result = filter.runFilter();      è¿™ä¸ªæ–¹æ³•ã€‚



runFilteræ–¹æ³•è°ƒç”¨runæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯åœ¨IZuulFilterä¸­å®šä¹‰çš„ã€‚



```java
public interface IZuulFilter {
	
    /**
     * a "true" return from this method means that the run() method should be invoked
     *
     * @return true if the run() method should be invoked. false will not invoke the run() method
     */
	boolean shouldFilter();
	
    /**
     * if shouldFilter() is true, this method will be invoked. this method is the core method of a ZuulFilter
     *
     * @return Some arbitrary artifact may be returned. Current implementation ignores it.
     */
	Object run() throws ZuulException;

}
```



**ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„è¿‡æ»¤å™¨çš„æ¡ä»¶å’Œactionã€‚**



```java
public ZuulFilterResult runFilter() {
		ZuulFilterResult tr = new ZuulFilterResult();

		if (!filterDisabled.get()) {		    
			if (shouldFilter()) {
				try {
					// çœŸæ­£æ‰§è¡Œè¿‡æ»¤å™¨çš„é€»è¾‘
					Object res = run();
					tr.setStatus(ExecutionStatus.SUCCESS);
					tr.setResult(res);
				} catch (Throwable t) {
					tr.setException(t);
					tr.setStatus(ExecutionStatus.FAILED);
				}
			} else {
				tr.setStatus(ExecutionStatus.SKIPPED);
			}
		}

		return tr;
	}
```

